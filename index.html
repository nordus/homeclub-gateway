<!DOCTYPE html><html lang="en"><head><title>index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="index"><meta name="groc-project-path" content="lib/decode.coffee"><meta name="groc-github-url" content="https://github.com/nordus/homeclub-gateway"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/nordus/homeclub-gateway/blob/master/lib/decode.coffee">lib/decode.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="decode">Decode</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">ack = </span><span class="nx">require</span> <span class="s1">&#39;./ack&#39;</span>
<span class="nv">log = </span><span class="nx">require</span> <span class="s1">&#39;./log&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>parse functions for each message type</p></div></div><div class="code"><div class="wrapper"><span class="nv">parse =</span>
  <span class="s1">&#39;0&#39;</span><span class="o">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./msg-type-0&#39;</span><span class="p">)</span>
  <span class="s1">&#39;2&#39;</span><span class="o">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./msg-type-2&#39;</span><span class="p">)</span>
  <span class="s1">&#39;4&#39;</span><span class="o">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./msg-type-4&#39;</span><span class="p">)</span>
  <span class="s1">&#39;5&#39;</span><span class="o">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./msg-type-5&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>msg</code>   : buffer. raw message from the device</li>
<li><code>rinfo</code> : object. contains <code>port</code> and <code>address</code> the message originated from</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports = </span><span class="nf">(msg, rinfo) -&gt;</span>

  <span class="k">try</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>parse attributes common to all message types</p></div></div><div class="code"><div class="wrapper">    <span class="nv">reading =</span>
      <span class="nv">serviceType         : </span><span class="nx">msg</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="nv">msgType             : </span><span class="nx">msg</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>reversing order per Rod's request
"B82167800700" => "0007806721B8"</p></div></div><div class="code"><div class="wrapper">      <span class="nv">macAddress          : </span><span class="nx">msg</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\w{2}/g</span><span class="p">).</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span>
      <span class="nv">sequenceNumber      : </span><span class="nx">msg</span><span class="p">.</span><span class="nx">readUInt16LE</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>we receive 10 digit epoch timestamp, JavaScript requires 13</p></div></div><div class="code"><div class="wrapper">      <span class="nv">updateTime          : </span><span class="p">(</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">readUInt32BE</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>signed</p></div></div><div class="code"><div class="wrapper">      <span class="nv">rssi                : </span><span class="nx">msg</span><span class="p">.</span><span class="nx">readInt8</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>rssiUnused        : msg.readInt8(15)</p></div></div><div class="code"><div class="wrapper">      </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>DEBUG</p></div></div><div class="code"><div class="wrapper">      <span class="nv">hex                 : </span><span class="nx">msg</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>append attributes specific to message type</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">parse</span><span class="p">[</span><span class="s2">&quot;#{reading.msgType}&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nx">parse</span><span class="p">[</span><span class="s2">&quot;#{reading.msgType}&quot;</span><span class="p">](</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">reading</span><span class="p">)</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>do not ack or save if in development</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">is</span> <span class="s1">&#39;test&#39;</span>
      <span class="k">return</span> <span class="nx">reading</span>
    <span class="k">else</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="nx">reading</span><span class="p">,</span> <span class="s2">&quot;SUCCESS parsing #{rinfo.size} bytes from #{rinfo.address}&quot;</span>
      
      <span class="nx">ack</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">rinfo</span><span class="p">)</span>


  <span class="k">catch</span> <span class="nx">e</span>
    <span class="nv">logObject =</span>
      <span class="nv">err:</span>
        <span class="nv">message : </span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span>
        <span class="nv">name    : </span><span class="nx">e</span><span class="p">.</span><span class="nx">name</span>
        <span class="nv">stack   : </span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span>
      <span class="nv">hex: </span><span class="nx">msg</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
      <span class="nv">text: </span><span class="nx">msg</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">is</span> <span class="s1">&#39;test&#39;</span>
      <span class="k">return</span> <span class="nx">logObject</span>
    <span class="k">else</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">error</span> <span class="nx">logObject</span><span class="p">,</span> <span class="s2">&quot;ERROR parsing #{rinfo.size} bytes from #{rinfo.address}&quot;</span></div></div></div></div></body></html>